<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AirProj — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root{
      --accent:#0b76ef;
      --bg:#ffffff;
      --muted:#666;
      --panel-bg: #ffffff;
      --card-shadow: 0 6px 18px rgba(12,20,30,0.08);
    }
    html,body,#map { height:100%; margin:0; padding:0; font-family: Inter, system-ui, Arial; background:#f4f6f8; }
    #sidebar { position:absolute; right:0; top:0; width:380px; height:100%; overflow:auto; background:var(--panel-bg); padding:18px; box-shadow:-6px 0 24px rgba(9,14,20,0.06); z-index:400; }
    #map { position: absolute; left:0; top:0; right:380px; bottom:0; }
    .btn { background:var(--accent); color:white; border:none; padding:8px 10px; border-radius:8px; cursor:pointer; }
    input[type=text], select { width:100%; padding:8px; margin-top:6px; margin-bottom:8px; border-radius:6px; border:1px solid #e4e7eb; }
    h3 { margin:0 0 8px 0; font-weight:600; }
    .small { font-size:12px; color:var(--muted); }
    .card { background: #fff; padding:12px; border-radius:10px; box-shadow: var(--card-shadow); margin-bottom:12px; }
    .row { display:flex; gap:8px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h3>AirProj — Dashboard</h3>
    <div class="small">Backend</div>
    <input id="apiUrl" placeholder="API base URL (no trailing slash)" value="http://127.0.0.1:8010" />
    <div style="margin:8px 0 12px;">
      <button id="btnSetApi" class="btn">Set API</button>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Quick Search (natural language)</strong>
      </div>
      <div class="small">Type a place like "Connaught Place, Delhi" or "Noida Sector 62"</div>
      <input id="loc-input" type="text" placeholder="e.g., Connaught Place, Delhi" />
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button id="predict-btn" class="btn">Predict AQI</button>
        <button id="loc-clear" style="background:#eee;border:none;padding:8px;border-radius:8px;cursor:pointer;">Clear</button>
      </div>
      <div id="nlResult" class="small" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <strong>Stations</strong>
      <div class="small">Click refresh to load station points</div>
      <div style="margin-top:8px;"><button id="btnRefreshStations" class="btn">Refresh Stations</button></div>
      <div id="stationsList" style="margin-top:10px;" class="small">No stations loaded.</div>
    </div>

    <div class="card">
      <strong>Interpolation (IDW)</strong>
      <div class="small">Compute spatial grid from station PM2.5</div>
      <div style="margin-top:8px;">
        <button id="btnInterp" class="btn">Compute / Refresh Grid</button>
      </div>
      <div id="interpStatus" class="small" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <strong>Safe route demo</strong>
      <div class="small">Click map once for start, once for end — or paste coords below</div>
      <input id="startCoord" placeholder="28.6139,77.2090" />
      <input id="endCoord" placeholder="28.7041,77.1025" />
      <div style="margin-top:8px;">
        <button id="btnRoute" class="btn">Compute Safe vs Fast</button>
      </div>
      <div id="routeInfo" class="small" style="margin-top:8px;"></div>
    </div>

  </div>

  <!-- external libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // state
    const state = {
      apiUrl: document.getElementById('apiUrl').value.replace(/\/+$/,''),
      markers: [],
      clusterGroup: null,
      gridLayer: null,
      routesLayer: L.layerGroup().addTo(map),
    };

    // map init
    let map = L.map('map').setView([28.65,77.2], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, attribution: '© OpenStreetMap, CARTO' }).addTo(map);

    // elements
    const apiInput = document.getElementById('apiUrl');
    document.getElementById('btnSetApi').onclick = () => {
      state.apiUrl = apiInput.value.trim().replace(/\/+$/,'');
      localStorage.setItem('airproj_api', state.apiUrl);
      alert('API set: ' + state.apiUrl);
    };
    // persist
    const stored = localStorage.getItem('airproj_api');
    if(stored){ state.apiUrl = stored; apiInput.value = stored; }

    async function fetchJson(path, opts){
      const url = state.apiUrl + path;
      try {
        const res = await fetch(url, opts);
        if(!res.ok){
          const txt = await res.text();
          throw new Error(res.status + ' ' + res.statusText + ' - ' + txt);
        }
        return await res.json();
      } catch(e) {
        console.error('fetch error', e);
        throw e;
      }
    }

    // --- stations ---
    async function loadStations(){
      document.getElementById('stationsList').innerText = 'Loading...';
      try {
        const data = await fetchJson('/stations');
        // if data is list or {stations:[]}
        const arr = Array.isArray(data) ? data : (data.stations || []);
        // clear markers
        if(state.clusterGroup) { map.removeLayer(state.clusterGroup); state.clusterGroup.clearLayers(); }
        state.clusterGroup = L.markerClusterGroup();
        arr.forEach(s => {
          if(!s.lat || !s.lon) return;
          const marker = L.marker([s.lat, s.lon], {title: `Station ${s.station_id || ''}`});
          const popupHtml = `<div style="width:200px"><b>Station ${s.station_id || ''}</b><div class="small">PM2.5: ${s.pm25 ?? '—'}</div><canvas id="chart-${s.station_id}" width="200" height="80"></canvas></div>`;
          marker.bindPopup(popupHtml);
          marker.on('popupopen', async () => {
            // request history and draw Chart.js mini chart into popup canvas
            try {
              const hist = await fetchJson(`/history/${s.station_id}`);
              const ctx = document.querySelector(`#chart-${s.station_id}`).getContext('2d');
              const labels = hist.history.map(d => new Date(d.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
              const dataSer = hist.history.map(d => d.aqi);
              new Chart(ctx, {type:'line', data:{labels, datasets:[{label:'AQI', data:dataSer, fill:true, tension:0.35, pointRadius:0}]}, options:{plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}}});
            } catch(e) { /* ignore chart errors */ }
          });
          state.clusterGroup.addLayer(marker);
        });
        map.addLayer(state.clusterGroup);
        document.getElementById('stationsList').innerText = `Stations: ${arr.length}`;
        if(arr.length) map.fitBounds(state.clusterGroup.getBounds().pad(0.15));
      } catch(e){
        document.getElementById('stationsList').innerText = 'Failed to load stations: ' + (e.message||e);
      }
    }
    document.getElementById('btnRefreshStations').onclick = loadStations;

    // --- interpolate ---
    document.getElementById('btnInterp').onclick = async () => {
      document.getElementById('interpStatus').innerText = 'Computing...';
      try {
        const r = await fetchJson('/interpolate?force=true');
        document.getElementById('interpStatus').innerText = `Done: ${JSON.stringify(r)}`;
        await loadGrid();
      } catch(e){
        document.getElementById('interpStatus').innerText = 'Interpolate failed: ' + (e.message||e);
      }
    };

    async function loadGrid(){
      try {
        const data = await fetchJson('/grid');
        const points = Array.isArray(data) ? data : (data.points || data);
        if(state.gridLayer) map.removeLayer(state.gridLayer);
        const g = L.layerGroup();
        points.forEach(p => {
          const c = p.pm25 > 150 ? '#b30000' : p.pm25 > 100 ? '#e65c00' : p.pm25 > 60 ? '#ffcc00' : '#59b300';
          L.circleMarker([p.lat,p.lon], {radius:3, fillColor:c, color:c, weight:0.2}).addTo(g);
        });
        state.gridLayer = g.addTo(map);
      } catch(e){ console.warn('grid load failed', e); }
    }

    // --- search NL (predict_text) ---
    document.getElementById('predict-btn').onclick = async () => {
      const text = document.getElementById('loc-input').value.trim();
      if(!text) return alert('Type a place');
      document.getElementById('nlResult').innerText = 'Searching...';
      try {
        const res = await fetchJson('/predict_text', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ location_text: text })
        });
        document.getElementById('nlResult').innerText = `AQI ${res.predicted_aqi} — ${res.category} at ${res.location.address || ''}`;
        const m = L.marker([res.location.lat,res.location.lon], {title: res.location.address}).addTo(map);
        const popup = `<b>${res.location.address}</b><div class="small">AQI: ${res.predicted_aqi} (${res.category})</div>`;
        m.bindPopup(popup).openPopup();
        map.setView([res.location.lat,res.location.lon], 13);
      } catch(e){
        document.getElementById('nlResult').innerText = 'Search failed: ' + (e.message||e);
      }
    };

    // --- route demo ---
    let clickCount = 0;
    map.on('click', ev => {
      clickCount++;
      if(clickCount % 2 === 1) document.getElementById('startCoord').value = `${ev.latlng.lat.toFixed(6)},${ev.latlng.lng.toFixed(6)}`;
      else document.getElementById('endCoord').value = `${ev.latlng.lat.toFixed(6)},${ev.latlng.lng.toFixed(6)}`;
    });

    document.getElementById('btnRoute').onclick = async () => {
      const startRaw = document.getElementById('startCoord').value.trim();
      const endRaw = document.getElementById('endCoord').value.trim();
      if(!startRaw || !endRaw) return alert('Paste start and end coords or click map twice');
      const [slat,slon] = startRaw.split(',').map(x=>parseFloat(x.trim()));
      const [elat,elon] = endRaw.split(',').map(x=>parseFloat(x.trim()));
      document.getElementById('routeInfo').innerText = 'Computing...';
      try {
        const res = await fetchJson(`/safe_route?start_lat=${slat}&start_lon=${slon}&end_lat=${elat}&end_lon=${elon}&samples=80`);
        document.getElementById('routeInfo').innerText = `Safe avg: ${res.safe_route.exposure.avg_pm25?.toFixed(1)}, Fast avg: ${res.fast_route.exposure.avg_pm25?.toFixed(1)}`;
        // draw
        if(state.routesLayer) { state.routesLayer.clearLayers(); }
        const fast = res.fast_route.coords.map(c=>[c[0],c[1]]);
        const safe = res.safe_route.coords.map(c=>[c[0],c[1]]);
        L.polyline(fast,{color:'blue',weight:4,opacity:0.6}).addTo(state.routesLayer);
        L.polyline(safe,{color:'green',weight:3,opacity:0.8}).addTo(state.routesLayer);
        map.fitBounds(L.featureGroup([L.polyline(fast),L.polyline(safe)]).getBounds().pad(0.15));
      } catch(e){ document.getElementById('routeInfo').innerText = 'Route failed: ' + (e.message||e); }
    };

    // init
    (async ()=> {
      try {
        await loadStations();
        await loadGrid();
      } catch(e){ console.warn('init error', e); }
    })();
  </script>
</body>
</html>
